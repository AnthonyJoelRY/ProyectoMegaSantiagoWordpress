<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resultados de b√∫squeda | MegaSantiago</title>

    <!-- CSS (desde View/pages ‚Üí Model) -->
    <link rel="stylesheet" href="../../Model/csss estilos/estilos.css" />
  </head>
  <body>
    <!-- ===== LAYOUT ===== -->
    <div id="header"></div>
    <div id="nav"></div>
    <!-- ================== -->

    <!-- CONTENIDO PRINCIPAL SIN SIDEBAR -->
    <main class="category-page">
      <div class="category-main-header" style="padding: 20px">
        <h1 style="font-size: 22px">
          Resultados de b√∫squeda:
          <span id="texto-busqueda" style="font-weight: 700"></span>
        </h1>
        <p id="resumen-resultados"></p>
      </div>

      <div class="product-grid" id="grid-resultados" style="width: 100%"></div>
    </main>

    <!-- ===== FOOTER ===== -->
    <div id="footer"></div>
    <div id="scripts"></div>
    <!-- ================== -->

    <script>
      // üîπ Misma URL de la API que en bazar.html (NO TOCAR)
      const API_URL = "/MegaSantiagoFront/Controller/productosController.php";

      /* ================== IM√ÅGENES (Firebase + local) ================== */
      // ‚úÖ Esta p√°gina est√° en View/pages/, por eso el fallback local es ../../Model/...
      function resolverImagen(img) {
        if (!img || String(img).trim() === "") {
          return "../../Model/imagenes/sin-imagen.png";
        }

        const limpia = String(img).trim();

        // ‚úÖ Firebase / URL externa
        if (limpia.startsWith("http://") || limpia.startsWith("https://")) {
          return limpia;
        }

        // ‚úÖ Ruta vieja local guardada en BD: "imagenes/xxx.jpg"
        return "../../Model/" + limpia;
      }

      /* ================== BUSCAR (redirecci√≥n) ================== */
      function realizarBusqueda() {
        const input = document.getElementById("buscador");
        if (!input) return;
        const termino = input.value.trim();
        if (!termino) return;
        window.location.href = "busqueda.html?q=" + encodeURIComponent(termino);
      }

      /* ==================================================
         OPCI√ìN 1 (ALIAS PARA HEADER)
         El header de la plantilla llama SIEMPRE:
           onclick="realizarBusquedaGlobal()"
         Aqu√≠ lo redirigimos a la l√≥gica local
      ================================================== */
      function realizarBusquedaGlobal() {
        realizarBusqueda();
      }

      /* ================== OBTENER T√âRMINO ================== */
      function obtenerTerminoBusqueda() {
        const params = new URLSearchParams(window.location.search);
        return params.get("q") || "";
      }

      /* ================== CARRITO (localStorage) ================== */
      function obtenerCarrito() {
        return JSON.parse(localStorage.getItem("carritoMega") || "[]");
      }

      function guardarCarrito(carrito) {
        localStorage.setItem("carritoMega", JSON.stringify(carrito));
      }

      function agregarAlCarrito(id, nombre, precio) {
        let carrito = obtenerCarrito();
        const existe = carrito.find((p) => p.id === id);
        if (existe) {
          existe.cantidad += 1;
        } else {
          carrito.push({ id, nombre, precio, cantidad: 1 });
        }
        guardarCarrito(carrito);
      }

      /* ================== CREAR TARJETA DESDE BD ================== */
      function crearTarjetaProducto(prod) {
        const precioBase = parseFloat(prod.precio);
        const precioOferta = prod.precio_oferta
          ? parseFloat(prod.precio_oferta)
          : null;
        const precioMostrar =
          precioOferta && precioOferta > 0 ? precioOferta : precioBase;

        // ‚úÖ Nueva l√≥gica: soporta Firebase (https://...) y local ("imagenes/..")
        const rutaImagen = resolverImagen(prod.imagen);

        const article = document.createElement("article");
        article.className = "product-card";
        article.dataset.id = prod.id;
        article.dataset.precio = precioMostrar.toFixed(2);

        article.innerHTML = `
          <div class="product-image">
            <img src="${rutaImagen}" alt="${prod.nombre}">
          </div>
          <h3>${prod.nombre}</h3>
          <p class="product-price">$${precioMostrar.toFixed(2)} + IVA</p>
          <button class="btn-add-grid" type="button">Agregar al carrito</button>
        `;

        const btn = article.querySelector(".btn-add-grid");
        btn.addEventListener("click", () => {
          agregarAlCarrito(prod.id, prod.nombre, precioMostrar);
          alert("Producto agregado al carrito");
        });

        return article;
      }

      /* ================== CARGAR RESULTADOS DESDE LA API ================== */
      async function cargarResultados() {
        const termino = obtenerTerminoBusqueda();
        const spanTexto = document.getElementById("texto-busqueda");
        const resumen = document.getElementById("resumen-resultados");
        const grid = document.getElementById("grid-resultados");

        spanTexto.textContent = termino ? "‚Äú" + termino + "‚Äù" : "";

        if (!termino) {
          resumen.textContent = "Escribe algo en el buscador para comenzar.";
          grid.innerHTML = "";
          return;
        }

        grid.innerHTML = "<p>Cargando resultados...</p>";

        try {
          const resp = await fetch(
            `${API_URL}?accion=buscar&q=${encodeURIComponent(termino)}`
          );
          const data = await resp.json();

          console.log("RESPUESTA BUSQUEDA:", data);

          if (data.error) {
            resumen.textContent = "Ocurri√≥ un error al buscar.";
            grid.innerHTML = `<p>Error: ${data.error}</p>`;
            return;
          }

          if (!Array.isArray(data) || data.length === 0) {
            resumen.textContent = "No se encontraron productos para este t√©rmino.";
            grid.innerHTML = "<p>No hay productos disponibles.</p>";
            return;
          }

          resumen.textContent = `Mostrando ${data.length} resultado${
            data.length > 1 ? "s" : ""
          }`;
          grid.innerHTML = "";

          data.forEach((prod) => {
            const card = crearTarjetaProducto(prod);
            grid.appendChild(card);
          });
        } catch (error) {
          console.error(error);
          resumen.textContent = "Ocurri√≥ un error al buscar.";
          grid.innerHTML = "<p>Error al cargar los resultados.</p>";
        }
      }

      /* ========= Inicializaci√≥n: esperar a que el layout cargue ========= */
      function initBusquedaPage() {
        const input = document.getElementById("buscador");

        const terminoActual = obtenerTerminoBusqueda();
        if (input && terminoActual) input.value = terminoActual;

        if (input) {
          input.addEventListener("keyup", (e) => {
            if (e.key === "Enter") realizarBusqueda();
          });
        }

        cargarResultados();
      }
    </script>

    <!-- ===== LAYOUT LOADER ===== -->
    <script src="../js/layout-loader.js"></script>
    <script>
      // ‚úÖ Primero carga header/nav/footer/scripts, luego engancha eventos del buscador
      loadLayout().then(() => {
        initBusquedaPage();
      });
    </script>
  </body>
</html>
